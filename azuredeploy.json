{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]"
        },
        "functionAppName": {
            "type": "string",
            "defaultValue": "[concat('func',uniqueString(resourceGroup().id, deployment().name))]"
        },
        "artifactsBaseUrl": {
            "type": "string",
            "metadata": {
                "artifactsBaseUrl": "The base URL of the ARM Template's resources (child templates and supporting VM extension scripts). For Azure Marketplace gallery packages, this value is passed by the Azure portal."
            },
            "defaultValue": "https://raw.githubusercontent.com/StratusOn/MSI-GetToken-FunctionApp/master"
        },
        "artifactsBaseUrlSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "The SAS token (including the leading '?') if artifactsBaseUrl represents an Azure Storage account. The SAS token should be setup to have at least read on the blob or read+list on the container."
            },
            "defaultValue": ""
        }
    },
    "variables": {
        "functionName": "GetToken",
        "createFunctionAppUrl": "[concat(parameters('artifactsBaseUrl'), '/createFunctionApp.json', parameters('artifactsBaseUrlSasToken'))]",
        "applyRbacUrl": "[concat(parameters('artifactsBaseUrl'), '/applyRBAC.json', parameters('artifactsBaseUrlSasToken'))]",
        "uniqueSuffix": "[uniqueString(resourceGroup().id, deployment().name)]",
        "storageAccountName": "[concat('stor', variables('uniqueSuffix'))]",
        "hostingPlanName": "[concat('plan', variables('uniqueSuffix'))]",
        "roleAssignmentId": "[guid(resourceGroup().id, deployment().name)]",
        "functionAppIdentityResourceId": "[concat(resourceId('Microsoft.Web/sites', parameters('functionAppName')),'/providers/Microsoft.ManagedIdentity/Identities/default')]",
        "storageApiVersion": "2016-12-01",
        "appServiceApiVersion": "2016-08-01",
        "hostingPlanApiVersion": "2016-09-01",
        "roleAssignmentsApiVersion": "2016-07-01",
        "msiApiVersion": "2015-08-31-PREVIEW",
        "deploymentsApiVersion": "2016-09-01"
    },
    "resources": [
        {
            "apiVersion": "[variables('storageApiVersion')]",
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('storageAccountName')]",
            "location": "[parameters('location')]",
            "kind": "Storage",
            "sku": {
                "name": "Standard_LRS"
            }
        },
        {
            "name": "createFunctionApp",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('deploymentsApiVersion')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('createFunctionAppUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "storageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "hostingPlanName": {
                        "value": "[variables('hostingPlanName')]"
                    },
                    "functionAppName": {
                        "value": "[parameters('functionAppName')]"
                    },
                    "functionName": {
                        "value": "[variables('functionName')]"
                    },
                    "storageApiVersion": {
                        "value": "[variables('storageApiVersion')]"
                    },
                    "appServiceApiVersion": {
                        "value": "[variables('appServiceApiVersion')]"
                    },
                    "hostingPlanApiVersion": {
                        "value": "[variables('hostingPlanApiVersion')]"
                    }
                }
            }
        },
        {
            "name": "applyRbac",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('deploymentsApiVersion')]",
            "dependsOn": [
                "Microsoft.Resources/deployments/createFunctionApp"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('applyRbacUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "roleAssignmentId": {
                        "value": "[variables('roleAssignmentId')]"
                    },
                    "roleAssignmentsApiVersion": {
                        "value": "[variables('roleAssignmentsApiVersion')]"
                    },
                    "functionAppIdentityResourceId": {
                        "value": "[variables('functionAppIdentityResourceId')]"
                    },
                    "msiApiVersion": {
                        "value": "[variables('msiApiVersion')]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "getDefaultTokenEndpoint": {
            "type": "string",
            "value": "[reference('Microsoft.Resources/deployments/createFunctionApp', variables('deploymentsApiVersion')).outputs.getDefaultTokenEndpoint.value]"
        },
        "getAMSTokenEndpoint": {
            "type": "string",
            "value": "[reference('Microsoft.Resources/deployments/createFunctionApp', variables('deploymentsApiVersion')).outputs.getAMSTokenEndpoint.value]"
        },
        "getDefaultTokenEndpointWithDetails": {
            "type": "string",
            "value": "[reference('Microsoft.Resources/deployments/createFunctionApp', variables('deploymentsApiVersion')).outputs.getDefaultTokenEndpointWithDetails.value]"
        },
        "getAMSTokenEndpointWithDetails": {
            "type": "string",
            "value": "[reference('Microsoft.Resources/deployments/createFunctionApp', variables('deploymentsApiVersion')).outputs.getAMSTokenEndpointWithDetails.value]"
        },
        "functionTriggerUrl": {
            "type": "string",
            "value": "[reference('Microsoft.Resources/deployments/createFunctionApp', variables('deploymentsApiVersion')).outputs.functionTriggerUrl.value]"
        }
    }
}